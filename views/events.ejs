<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Events</h1>

    <div class="text-end">
      <% if (loggedInUserId && loggedInLevel) { %>
        Logged in as <strong><%= loggedInLevel === 'M' ? 'Manager' : 'User' %>:</strong>
        <span><%= loggedInUserId %></span>
      <% } else { %>
        Logged in as <strong>Not logged in</strong>
      <% } %>
      <div class="mt-2">
        <a href="/landing?userId=<%= loggedInUserId || '' %>&level=<%= loggedInLevel || '' %>"
           class="btn btn-sm btn-outline-secondary">
          Back to dashboard
        </a>
      </div>
    </div>
  </div>

  <% const isManager = (loggedInLevel === 'M'); %>
  <% const registeredIds = (Array.isArray(myInstanceIds) ? myInstanceIds : []).map(id => Number(id)); %>
  <% const myRegsSafe = Array.isArray(myRegistrations) ? myRegistrations : []; %>
  <% const instancesSafe = Array.isArray(eventInstances) ? eventInstances : []; %>

  <!-- USER: MY REGISTERED UPCOMING EVENTS -->
  <% if (!isManager) { %>
    <div class="card mb-4">
      <div class="card-header">
        My past events
      </div>
      <div class="card-body p-0">
        <table class="table mb-0 table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>Type</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>Location</th>
          </tr>
          </thead>
          <tbody>
          <% if (!loggedInUserId) { %>
            <tr><td colspan="5" class="text-center py-3 text-muted">Log in to see your events.</td></tr>
          <% } else if (myRegsSafe.length === 0) { %>
            <tr><td colspan="5" class="text-center py-3 text-muted">No past events found.</td></tr>
          <% } else { %>
            <% myRegsSafe.forEach(r => { %>
              <tr>
                <td><%= r.event_name %></td>
                <td><%= r.event_type || '' %></td>
                <td><%= new Date(r.event_datetime_start).toLocaleString() %></td>
                <td><%= new Date(r.event_datetime_end).toLocaleString() %></td>
                <td><%= r.event_location || '' %></td>
              </tr>
            <% }) %>
          <% } %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>

  <!-- MANAGER: EVENT INSTANCES + DEFINITIONS -->
  <% if (isManager) { %>
    <div class="card mb-4">
      <div class="card-header">
        <div class="d-flex flex-column flex-lg-row gap-2 align-items-lg-center justify-content-between">
          <span>Event instances (all dates)</span>
          <form class="row g-2 align-items-center" method="GET" action="/events">
            <input type="hidden" name="userId" value="<%= loggedInUserId || '' %>">
            <input type="hidden" name="level" value="<%= loggedInLevel || '' %>">
            <div class="col-auto">
              <input class="form-control form-control-sm"
                     type="text"
                     name="q"
                     value="<%= search || '' %>"
                     placeholder="Search by name, type, description, or location">
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-primary" type="submit">Search</button>
            </div>
          </form>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table mb-0 table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>Type</th>
            <th>Description</th>
            <th>Starts</th>
            <th>Ends</th>
            <th>Location</th>
            <th>Capacity</th>
            <th>Registration deadline</th>
            <th style="width: 170px;">Actions</th>
          </tr>
          </thead>
          <tbody>
          <% if (instancesSafe && instancesSafe.length > 0) { %>
            <% instancesSafe.forEach(ei => { %>
              <tr>
                <td><%= ei.event_name %></td>
                <td><%= ei.event_type || '' %></td>
                <td style="max-width: 260px;"><%= ei.event_description || '' %></td>
                <td><%= new Date(ei.event_datetime_start).toLocaleString() %></td>
                <td><%= new Date(ei.event_datetime_end).toLocaleString() %></td>
                <td><%= ei.event_location || '' %></td>
                <td><%= ei.event_capacity != null ? ei.event_capacity : '' %></td>
                <td>
                  <% if (ei.event_registration_deadline) { %>
                    <%= new Date(ei.event_registration_deadline).toLocaleString() %>
                  <% } %>
                </td>
                <td>
                  <div class="d-flex flex-column gap-1">
                    <form method="POST"
                          class="row gx-1 gy-1 align-items-center"
                          action="/event_instances/edit/<%= ei.event_instance_id %>?userId=<%= loggedInUserId %>&level=<%= loggedInLevel %>">
                      <div class="col-12 col-lg-6">
                        <input type="datetime-local" name="event_datetime_start" class="form-control form-control-sm"
                               value="<%= new Date(ei.event_datetime_start).toISOString().slice(0,16) %>" required>
                      </div>
                      <div class="col-12 col-lg-6">
                        <input type="datetime-local" name="event_datetime_end" class="form-control form-control-sm"
                               value="<%= new Date(ei.event_datetime_end).toISOString().slice(0,16) %>" required>
                      </div>
                      <div class="col-12 col-lg-5">
                        <input name="event_location" class="form-control form-control-sm"
                               value="<%= ei.event_location || '' %>" placeholder="Location">
                      </div>
                      <div class="col-6 col-lg-3">
                        <input name="event_capacity" type="number" min="0"
                               class="form-control form-control-sm"
                               value="<%= ei.event_capacity != null ? ei.event_capacity : '' %>" placeholder="Capacity">
                      </div>
                      <div class="col-6 col-lg-4">
                        <input type="datetime-local" name="event_registration_deadline"
                               class="form-control form-control-sm"
                               value="<%= ei.event_registration_deadline ? new Date(ei.event_registration_deadline).toISOString().slice(0,16) : '' %>">
                      </div>
                      <div class="col-12">
                        <button class="btn btn-sm btn-outline-primary w-100" type="submit">Save changes</button>
                      </div>
                    </form>

                    <form method="POST"
                          action="/event_instances/delete/<%= ei.event_instance_id %>?userId=<%= loggedInUserId %>&level=<%= loggedInLevel %>"
                          onsubmit="return confirm('Delete this event instance?');">
                      <button class="btn btn-sm btn-outline-danger w-100" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="9" class="text-center py-3">
                No event instances found.
              </td>
            </tr>
          <% } %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>

  <!-- MANAGER: EVENT DEFINITIONS CRUD -->
  <% if (isManager) { %>
    <div class="card">
      <div class="card-header">
        Manage event definitions (not instances)
      </div>
      <div class="card-body">
        <h5>Existing events</h5>
        <table class="table table-sm table-hover align-middle mb-4">
          <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Description</th>
            <th>Recurrence</th>
            <th>Default capacity</th>
            <th style="width: 200px;">Actions</th>
          </tr>
          </thead>
          <tbody>
          <% if (events && events.length > 0) { %>
            <% events.forEach(e => { %>
              <tr>
                <td><%= e.event_name %></td>
                <td><%= e.event_type || '' %></td>
                <td style="max-width: 260px;"><%= e.event_description || '' %></td>
                <td><%= e.event_recurrence_pattern || '' %></td>
                <td><%= e.event_default_capacity != null ? e.event_default_capacity : '' %></td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <form method="POST"
                          action="/events/edit/<%= encodeURIComponent(e.event_name) %>?userId=<%= loggedInUserId %>&level=<%= loggedInLevel %>">
                      <div class="row g-1">
                        <div class="col-md-3">
                          <input name="event_type" class="form-control form-control-sm"
                                 placeholder="Type" value="<%= e.event_type || '' %>">
                        </div>
                        <div class="col-md-3">
                          <input name="event_recurrence_pattern" class="form-control form-control-sm"
                                 placeholder="Recurrence" value="<%= e.event_recurrence_pattern || '' %>">
                        </div>
                        <div class="col-md-3">
                          <input name="event_default_capacity" class="form-control form-control-sm"
                                 type="number" min="0" placeholder="Capacity"
                                 value="<%= e.event_default_capacity != null ? e.event_default_capacity : '' %>">
                        </div>
                        <div class="col-md-3">
                          <button class="btn btn-sm btn-outline-primary w-100" type="submit">Update</button>
                        </div>
                      </div>
                    </form>

                    <form method="POST"
                          action="/events/delete/<%= encodeURIComponent(e.event_name) %>?userId=<%= loggedInUserId %>&level=<%= loggedInLevel %>"
                          onsubmit="return confirm('Delete this event definition?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="6" class="text-center py-2">No event definitions.</td>
            </tr>
          <% } %>
          </tbody>
        </table>

        <h5>Add new event definition</h5>
        <form class="row g-2" method="POST"
              action="/events/add?userId=<%= loggedInUserId %>&level=<%= loggedInLevel %>">
          <div class="col-md-3">
            <input name="event_name" class="form-control" placeholder="Event name" required>
          </div>
          <div class="col-md-2">
            <input name="event_type" class="form-control" placeholder="Type">
          </div>
          <div class="col-md-3">
            <input name="event_description" class="form-control" placeholder="Description">
          </div>
          <div class="col-md-2">
            <input name="event_recurrence_pattern" class="form-control" placeholder="Recurrence">
          </div>
          <div class="col-md-2">
            <input name="event_default_capacity" type="number" min="0" class="form-control" placeholder="Default capacity">
          </div>
          <div class="col-12">
            <button class="btn btn-success mt-2" type="submit">Add event</button>
          </div>
        </form>
      </div>
    </div>
  <% } %>

</div>
</body>
</html>
